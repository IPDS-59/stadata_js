name: Create Release PR to Main

on:
  create:
  push:
    branches:
      - 'release/**'
      - 'hotfix/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  create-release-pr:
    name: Create PR to Main Branch
    runs-on: ubuntu-latest
    if: github.event_name == 'create' || (github.event_name == 'push' && (startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/heads/hotfix/')))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Extract branch info
        id: branch_info
        run: |
          if [ "${{ github.event_name }}" = "create" ]; then
            BRANCH_NAME="${{ github.ref }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi

          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          # Determine branch type
          if [[ "$BRANCH_NAME" == release/* ]]; then
            BRANCH_TYPE="release"
            VERSION="${BRANCH_NAME#release/}"
          elif [[ "$BRANCH_NAME" == hotfix/* ]]; then
            BRANCH_TYPE="hotfix"
            VERSION="${BRANCH_NAME#hotfix/}"
          else
            echo "Not a release or hotfix branch"
            exit 0
          fi

          echo "branch_type=${BRANCH_TYPE}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Branch: ${BRANCH_NAME}, Type: ${BRANCH_TYPE}, Version: ${VERSION}"

      - name: Check for existing PR
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"

          # Check if there's already an open PR from this branch to main
          EXISTING_PRS=$(gh pr list --head "$BRANCH_NAME" --base main --state open --json number,title 2>/dev/null || echo "[]")

          if [ "$(echo "$EXISTING_PRS" | jq '. | length')" -gt 0 ]; then
            echo "⚠️ Found existing open PR from $BRANCH_NAME to main:"
            echo "$EXISTING_PRS" | jq -r '.[] | "#\(.number): \(.title)"'
            echo "skip_pr=true" >> $GITHUB_OUTPUT
            PR_NUMBER=$(echo "$EXISTING_PRS" | jq -r '.[0].number')
            echo "existing_pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "✅ No existing open PR found"
            echo "skip_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Create PR to main
        if: steps.check_pr.outputs.skip_pr == 'false'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
          BRANCH_TYPE="${{ steps.branch_info.outputs.branch_type }}"
          VERSION="${{ steps.branch_info.outputs.version }}"

          # Set PR title based on type
          if [ "$BRANCH_TYPE" = "release" ]; then
            PR_TITLE="release: version ${VERSION}"
          else
            PR_TITLE="fix: hotfix ${VERSION}"
          fi

          # Create PR with body from heredoc
          if [ "$BRANCH_TYPE" = "release" ]; then
            gh pr create \
              --base main \
              --head "$BRANCH_NAME" \
              --title "$PR_TITLE" \
              --body "$(cat <<EOF
## Release ${VERSION}

This PR merges the release branch for version **${VERSION}** to the main branch.

### Release Details
- **Version**: ${VERSION}
- **Type**: Release
- **Branch**: \`${BRANCH_NAME}\`

### What's included
- All features and bug fixes for version ${VERSION}
- Updated changelog (if merged)
- Version bump in package.json

### Checklist
- [ ] Changelog has been reviewed and merged
- [ ] All tests are passing
- [ ] Version is correct in package.json
- [ ] Ready to release

### Post-merge Actions
After merging this PR:
1. A git tag \`v${VERSION}\` will be created automatically
2. A GitHub release will be generated
3. A back-merge PR to develop will be created

**⚠️ Do not merge until ready to release to production**
EOF
)" \
              --label "release" \
              --label "release-candidate"
          else
            gh pr create \
              --base main \
              --head "$BRANCH_NAME" \
              --title "$PR_TITLE" \
              --body "$(cat <<EOF
## Hotfix ${VERSION}

This PR merges the hotfix branch for version **${VERSION}** to the main branch.

### Hotfix Details
- **Version**: ${VERSION}
- **Type**: Hotfix
- **Branch**: \`${BRANCH_NAME}\`

### What's included
- Critical bug fixes
- Updated changelog (if merged)
- Version bump in package.json

### Checklist
- [ ] Changelog has been reviewed and merged
- [ ] All tests are passing
- [ ] Version is correct in package.json
- [ ] Hotfix has been tested
- [ ] Ready to deploy

### Post-merge Actions
After merging this PR:
1. A git tag \`v${VERSION}\` will be created automatically
2. A GitHub release will be generated
3. A back-merge PR to develop will be created

**⚠️ Do not merge until ready to deploy hotfix**
EOF
)" \
              --label "hotfix" \
              --label "release-candidate"
          fi

          echo "✅ Created PR from $BRANCH_NAME to main"

      - name: Summary
        run: |
          BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
          BRANCH_TYPE="${{ steps.branch_info.outputs.branch_type }}"
          VERSION="${{ steps.branch_info.outputs.version }}"

          echo "## Release PR Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${BRANCH_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${BRANCH_TYPE}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: main" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_pr.outputs.skip_pr }}" = "true" ]; then
            echo "**Status**: ⚠️ Skipped - PR already exists (#${{ steps.check_pr.outputs.existing_pr_number }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status**: ✅ PR created successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the changelog PR and merge it" >> $GITHUB_STEP_SUMMARY
            echo "2. Ensure all tests pass" >> $GITHUB_STEP_SUMMARY
            echo "3. Review and merge the release PR when ready" >> $GITHUB_STEP_SUMMARY
          fi
