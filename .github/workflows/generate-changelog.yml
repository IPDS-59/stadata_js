name: Generate Changelog

on:
  push:
    branches:
      - 'release/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Extract version from branch
        id: extract_version
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          VERSION="${BRANCH_NAME#release/}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION}"

      - name: Install dependencies
        run: npm ci --if-present || npm install conventional-changelog-cli -g

      - name: Generate changelog
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          node .github/scripts/generate-changelog.js "${VERSION}"

      - name: Check for changelog changes
        id: check_changes
        run: |
          if git diff --quiet CHANGELOG.md; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes in CHANGELOG.md"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in CHANGELOG.md"
          fi

      - name: Check for existing PR
        id: check_existing_pr
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          PR_BRANCH="changelog/v${VERSION}"

          # Check if there's already a PR from this branch
          EXISTING_PRS=$(gh pr list --head "$PR_BRANCH" --base "${{ github.ref_name }}" --state open --json number,title 2>/dev/null || echo "[]")

          if [ "$(echo "$EXISTING_PRS" | jq '. | length')" -gt 0 ]; then
            echo "⚠️ Found existing PR from $PR_BRANCH:"
            echo "$EXISTING_PRS" | jq -r '.[] | "#\(.number): \(.title)"'
            echo "skip_pr=true" >> $GITHUB_OUTPUT
            PR_NUMBER=$(echo "$EXISTING_PRS" | jq -r '.[0].number')
            echo "existing_pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "✅ No existing PR found"
            echo "skip_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit changelog
        if: steps.check_changes.outputs.has_changes == 'true' && steps.check_existing_pr.outputs.skip_pr == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "docs: update changelog for version ${{ steps.extract_version.outputs.version }}"

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true' && steps.check_existing_pr.outputs.skip_pr == 'false'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          branch: changelog/v${{ steps.extract_version.outputs.version }}
          base: ${{ github.ref_name }}
          title: "docs: update changelog for version ${{ steps.extract_version.outputs.version }}"
          body: |
            ## Changelog Update

            This PR updates the CHANGELOG.md for version **${{ steps.extract_version.outputs.version }}**.

            ### Changes included:
            - Generated from conventional commits
            - Grouped by type (feat, fix, docs, etc.)
            - Ready for release

            Please review and merge if everything looks correct.
          labels: |
            documentation
            changelog
            automated
          commit-message: "docs: update changelog for version ${{ steps.extract_version.outputs.version }}"

      - name: Auto-merge changelog PR
        if: steps.check_changes.outputs.has_changes == 'true' && steps.check_existing_pr.outputs.skip_pr == 'false'
        run: |
          # Wait for PR to be created
          sleep 5

          # Get the PR number
          PR_NUMBER=$(gh pr list --head "changelog/v${{ steps.extract_version.outputs.version }}" --json number --jq '.[0].number')

          if [ -n "$PR_NUMBER" ]; then
            echo "Auto-merging PR #${PR_NUMBER}"
            gh pr merge ${PR_NUMBER} --auto --squash --delete-branch
          else
            echo "PR not found, skipping auto-merge"
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
