name: Generate Changelog

on:
  create:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    if: github.event.ref_type == 'branch' && startsWith(github.event.ref, 'release/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.ref }}
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Extract version from branch
        id: extract_version
        run: |
          BRANCH_NAME="${{ github.event.ref }}"
          VERSION="${BRANCH_NAME#release/}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION}"

      - name: Install dependencies
        run: npm ci --if-present || npm install conventional-changelog-cli -g

      - name: Generate changelog
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          node .github/scripts/generate-changelog.js "${VERSION}"

      - name: Check for changelog changes
        id: check_changes
        run: |
          # Check if CHANGELOG.md was created or modified
          if [ ! -f "CHANGELOG.md" ]; then
            # File doesn't exist, something went wrong
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ERROR: CHANGELOG.md was not created"
            exit 1
          fi

          # Check if file is tracked by git
          if git ls-files --error-unmatch CHANGELOG.md > /dev/null 2>&1; then
            # File is tracked, check for changes
            if git diff --quiet CHANGELOG.md; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "No changes in CHANGELOG.md"
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "Changes detected in CHANGELOG.md"
            fi
          else
            # File is untracked (new file)
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "CHANGELOG.md is a new file"
          fi

      - name: Check for existing PR
        id: check_existing_pr
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          PR_BRANCH="changelog/v${VERSION}"
          BASE_BRANCH="${{ github.event.ref }}"

          # Check if there's already an open PR from this branch
          EXISTING_PRS=$(gh pr list --head "$PR_BRANCH" --base "$BASE_BRANCH" --state open --json number,title 2>/dev/null || echo "[]")

          if [ "$(echo "$EXISTING_PRS" | jq '. | length')" -gt 0 ]; then
            echo "⚠️ Found existing open PR from $PR_BRANCH:"
            echo "$EXISTING_PRS" | jq -r '.[] | "#\(.number): \(.title)"'
            echo "skip_pr=true" >> $GITHUB_OUTPUT
            PR_NUMBER=$(echo "$EXISTING_PRS" | jq -r '.[0].number')
            echo "existing_pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "✅ No existing open PR found"
            echo "skip_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true' && steps.check_existing_pr.outputs.skip_pr == 'false'
        id: create_pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PAT_TOKEN }}
          branch: changelog/v${{ steps.extract_version.outputs.version }}
          base: ${{ github.event.ref }}
          title: "docs: update changelog for version ${{ steps.extract_version.outputs.version }}"
          body: |
            ## Changelog Update

            This PR updates the CHANGELOG.md for version **${{ steps.extract_version.outputs.version }}**.

            ### Changes included:
            - Generated from conventional commits
            - Grouped by type (feat, fix, docs, etc.)
            - Ready for release

            Please review and merge if everything looks correct.
          labels: |
            documentation
            changelog
            automated
          commit-message: "docs: update changelog for version ${{ steps.extract_version.outputs.version }}"

      - name: Summary
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "## Changelog Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.extract_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_existing_pr.outputs.skip_pr }}" = "true" ]; then
            echo "- **Status**: Skipped - PR already exists (#${{ steps.check_existing_pr.outputs.existing_pr_number }})" >> $GITHUB_STEP_SUMMARY
          elif [ -n "${{ steps.create_pr.outputs.pull-request-number }}" ]; then
            echo "- **Status**: PR created (#${{ steps.create_pr.outputs.pull-request-number }})" >> $GITHUB_STEP_SUMMARY
            echo "- **Action Required**: Please review and merge the changelog PR" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: No PR created" >> $GITHUB_STEP_SUMMARY
          fi
